<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">

  <title>ماشین‌حساب سفارشات بِلویــا</title>

  <!-- PWA Requirements -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#a68b78">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Belvia Calc">
  <link rel="apple-touch-icon" href="Brown.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="Brown.png">

  <!-- Persian Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #a68b78;
      --accent-dark: #8c6f5b;
      --bg-color: #faf7f3;
      --card-bg: #ffffff;
      --text-main: #2a2a2a;
      --border: #e3ddd8;
      --muted: #7a736d;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 25px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top, #ffffff 0%, #f2ede9 60%, #e7e1db 100%);
      font-family: "Vazirmatn", sans-serif;
      color: var(--text-main);
    }

    .container {
      width: 100%;
      max-width: 960px;
      background: var(--card-bg);
      border-radius: 22px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.10);
      padding: 24px 28px 30px;
    }

    .logo-box {
      text-align: center;
      margin-bottom: 20px;
    }

    .logo-box img {
      height: 130px;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.18));
    }

    h1 {
      text-align: center;
      margin: 0 0 8px;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--accent-dark);
    }

    .desc {
      text-align: center;
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 0.85rem;
    }

    .top-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    input[type="number"], input[type="text"] {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }

    input#customerName {
      width: 220px;
      direction: rtl;
      text-align: right;
    }

    input[type="number"] {
      width: 110px;
      text-align: left;
      direction: ltr;
    }

    #eurRateInput {
      width: 130px;
      text-align: left;
      direction: ltr;
    }

    button {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-main {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      box-shadow: 0 10px 18px rgba(166,139,120,0.35);
    }

    .btn-ghost {
      background: #f5eee7;
      color: #6c5e53;
      border-radius: 999px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.85rem;
      border-radius: 14px;
      overflow: hidden;
    }

    table th, table td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: center;
    }

    table th {
      background: #f7f2ee;
      color: #6c5e53;
      font-weight: 600;
    }

    .section-title {
      margin-top: 24px;
      margin-bottom: 8px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-dark);
    }

    .result-block {
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 14px;
      background: #f9f6f2;
      border: 1px solid #e8e2dc;
      font-size: 0.9rem;
    }

    .result-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .highlight {
      font-weight: 600;
      color: var(--accent-dark);
    }

    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
    }
  </style>
</head>

<body>

<div class="container">
  <div class="logo-box"><img src="Brown.png" alt="Belvia Logo"></div>

  <h1>ماشین‌حساب سفارشات بِلویــا</h1>
  <p class="desc">محاسبه‌ی قیمت، باربری، سود و هزینه‌ی نهایی (داخلی برای Belvia)</p>

  <div class="top-row">
    <label>نام مشتری:</label>
    <input id="customerName" type="text" placeholder="مثلاً خانم رضایی">
  </div>

  <!-- نرخ یورو به ریال بر اساس Bonbast (ورود دستی) -->
  <div class="top-row">
    <span style="font-size:0.85rem;">نرخ یورو به ریال (Bonbast):</span>
    <input id="eurRateInput" type="number" placeholder="مثلاً 620000">
    <button class="btn-main" type="button" onclick="setEurRateFromInput()">ثبت نرخ</button>
    <button class="btn-ghost" type="button" onclick="openBonbast()">باز کردن Bonbast</button>
    <span id="eurRateLabel" style="font-size:0.8rem;color:#7a736d;">(هنوز تنظیم نشده)</span>
  </div>

  <div class="top-row">
    <label>تعداد محصولات:</label>
    <input id="numProducts" type="number" min="1" value="1">
    <button class="btn-main" onclick="generateRows()">ثبت محصولات</button>
  </div>

  <table id="productsTable" style="display:none;">
    <thead>
      <tr>
        <th>ردیف</th><th>قیمت (€)</th><th>وزن (kg)</th><th>تخفیف (%)</th>
      </tr>
    </thead>
    <tbody id="productsTbody"></tbody>
  </table>

  <button id="calcBtn" class="btn-main" style="display:none;margin-top:12px;" onclick="calculate()">محاسبه</button>
  <button id="invoiceBtn" class="btn-main" style="display:none;margin-top:12px;" onclick="openInvoiceWindow()">فاکتور PDF برای مشتری</button>

  <div id="resultsSection" style="display:none;">

    <h2 class="section-title">نتایج برای مشتری</h2>
    <div class="result-block">
      <div class="result-line"><span>جمع قیمت کالا (بعد از تخفیف):</span><span id="r_totalBase"></span></div>
      <div class="result-line"><span>وزن کل سفارش:</span><span id="r_totalWeight"></span></div>
      <div class="result-line"><span>نرخ باربری از مشتری:</span><span id="r_shipRate"></span></div>
      <div class="result-line"><span>هزینه باربری از مشتری:</span><span id="r_shipCost"></span></div>
      <div class="result-line highlight"><span>مبلغ نهایی قابل پرداخت (یورو):</span><span id="r_finalPrice"></span></div>
      <div class="result-line">
        <span>مبلغ نهایی (تقریبی به ریال):</span>
        <span id="r_finalPriceRial"></span>
      </div>
    </div>

    <h2 class="section-title">نتایج داخلی برای Belvia</h2>
    <div class="result-block">
      <div class="result-line"><span>سود روی کالا (۲۲٪):</span><span id="r_profit"></span></div>
      <div class="result-line"><span>هزینه باربری واقعی تو (۱۵ €/kg):</span><span id="r_yourShip"></span></div>
      <div class="result-line"><span>هزینه تمام‌شده (کالا + باربری):</span><span id="r_yourTotal"></span></div>
      <div class="result-line highlight"><span>سود نهایی این سفارش:</span><span id="r_profitFinal"></span></div>
    </div>
  </div>

  <p class="footer">© ابزار داخلی Belvia – فقط برای مدیریت سفارش‌ها</p>
</div>

<script>
let eurToRialRate = null;  // نرخ یورو به ریال که از Bonbast می‌گیریم (دستی)

function openBonbast() {
  window.open("https://www.bonbast.com/", "_blank");
}

function setEurRateFromInput() {
  const input = document.getElementById("eurRateInput").value.trim();
  if (!input) {
    alert("لطفاً نرخ یورو به ریال را وارد کنید (از Bonbast).");
    return;
  }
  const val = parseFloat(input.replace(/,/g, ""));
  if (isNaN(val) || val <= 0) {
    alert("نرخ وارد شده معتبر نیست.");
    return;
  }
  eurToRialRate = val;
  document.getElementById("eurRateLabel").textContent =
    val.toLocaleString("fa-IR") + " ریال برای هر ۱ یورو";
}

function generateRows() {
  const n = parseInt(document.getElementById("numProducts").value);
  const tbody = document.getElementById("productsTbody");
  tbody.innerHTML = "";
  if (!n || n < 1) return;

  for (let i = 0; i < n; i++) {
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td><input id="p_${i}" type="number" step="0.01"></td>
        <td><input id="w_${i}" type="number" step="0.01"></td>
        <td><input id="d_${i}" type="number" value="0"></td>
      </tr>`;
  }

  document.getElementById("productsTable").style.display = "table";
  document.getElementById("calcBtn").style.display = "inline-block";
}

function calculate() {
  const rows = document.querySelectorAll("#productsTbody tr").length;
  let base = 0, weight = 0;

  for (let i = 0; i < rows; i++) {
    const p = parseFloat(document.getElementById(`p_${i}`).value) || 0;
    const w = parseFloat(document.getElementById(`w_${i}`).value) || 0;
    const d = parseFloat(document.getElementById(`d_${i}`).value) || 0;
    const eff = p * (1 - d / 100);

    base += eff;
    weight += w;
  }

  let rate = weight > 6 ? 25 : (base >= 100 ? 30 : 35);
  const ship = weight * rate;
  const profit = base * 0.22;
  const yourShip = weight * 15;
  const yourTotal = base + yourShip;
  const finalPrice = base + profit + ship;
  const profitFinal = finalPrice - yourTotal;

  // بخش مشتری (به یورو)
  document.getElementById("r_totalBase").textContent   = base.toFixed(2)   + " €";
  document.getElementById("r_totalWeight").textContent = weight.toFixed(2) + " kg";
  document.getElementById("r_shipRate").textContent    = rate + " €/kg";
  document.getElementById("r_shipCost").textContent    = ship.toFixed(2)   + " €";
  document.getElementById("r_finalPrice").textContent  = finalPrice.toFixed(2) + " €";

  // تبدیل به ریال اگر نرخ داریم
  if (eurToRialRate) {
    const rialValue = finalPrice * eurToRialRate;
    document.getElementById("r_finalPriceRial").textContent =
      rialValue.toLocaleString("fa-IR") + " ریال";
  } else {
    document.getElementById("r_finalPriceRial").textContent =
      "ابتدا نرخ را از Bonbast وارد کنید.";
  }

  // بخش داخلی
  document.getElementById("r_profit").textContent      = profit.toFixed(2)     + " €";
  document.getElementById("r_yourShip").textContent    = yourShip.toFixed(2)   + " €";
  document.getElementById("r_yourTotal").textContent   = yourTotal.toFixed(2)  + " €";
  document.getElementById("r_profitFinal").textContent = profitFinal.toFixed(2)+ " €";

  document.getElementById("resultsSection").style.display = "block";
  document.getElementById("invoiceBtn").style.display = "inline-block";
}

function openInvoiceWindow() {
  const rows = document.querySelectorAll("#productsTbody tr").length;
  if (rows === 0) return;

  const customer = document.getElementById("customerName").value || "مشتری";

  let baseNet = 0;        // جمع قیمت بعد از تخفیف (خالص داخلی)
  let totalRetail = 0;    // جمع قیمت بعد از سود ۲۲٪ و تخفیف (برای مشتری)
  let weight = 0;
  let rowsHtml = "";

  for (let i = 0; i < rows; i++) {
    const p = parseFloat(document.getElementById(`p_${i}`).value) || 0;
    const w = parseFloat(document.getElementById(`w_${i}`).value) || 0;
    const d = parseFloat(document.getElementById(`d_${i}`).value) || 0;

    const effNet = p * (1 - d / 100);   // قیمت خالص بعد تخفیف (داخلی)
    const retailBase = p * 1.22;        // قیمت واحد برای مشتری با سود ۲۲٪
    const retailFinal = effNet * 1.22;  // قیمت نهایی برای مشتری با تخفیف + سود

    baseNet     += effNet;
    totalRetail += retailFinal;
    weight      += w;

    rowsHtml += `
      <tr>
        <td>${i+1}</td>
        <td>${retailBase.toFixed(2)} €</td>
        <td>${d.toFixed(2)}%</td>
        <td>${retailFinal.toFixed(2)} €</td>
        <td>${w.toFixed(2)} kg</td>
      </tr>`;
  }

  // نرخ باربری مثل قبل بر اساس قیمت خالص داخلی
  let rate = weight > 6 ? 25 : (baseNet >= 100 ? 30 : 35);
  const ship = weight * rate;

  const finalPriceCustomer = totalRetail + ship;

  // محاسبه‌ی مبلغ نهایی به ریال (برای چاپ روی فاکتور)
  let finalPriceCustomerRialText = "نرخ ریال ثبت نشده است";
  if (eurToRialRate) {
    const rialVal = finalPriceCustomer * eurToRialRate;
    finalPriceCustomerRialText =
      rialVal.toLocaleString("fa-IR") + " ریال";
  }

  const date = new Date().toLocaleDateString("fa-IR");

  const html = `
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>فاکتور Belvia</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body{font-family:"Vazirmatn",sans-serif;margin:0;background:#f3efe9;color:#2a2a2a}
.card{max-width:820px;margin:30px auto;background:#fff;border-radius:18px;box-shadow:0 16px 40px rgba(0,0,0,0.1);overflow:hidden}
.header{background:linear-gradient(135deg,#a68b78,#8c6f5b);color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}
.header img{height:60px}
.header h2{margin:0;font-size:1.3rem}
.header span{font-size:.9rem;opacity:.9}
.body{padding:20px}
.info-row{display:flex;justify-content:space-between;flex-wrap:wrap;font-size:.9rem;margin-bottom:10px}
.info-row div{margin-bottom:4px}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.9rem}
th,td{border:1px solid #e1dad2;padding:6px;text-align:center}
th{background:#f7f3ef;color:#6c5e53}
tbody tr:nth-child(even){background:#fbf8f4}
.totals-wrap{margin-top:18px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px}
.totals-box{min-width:260px;border-radius:14px;border:1px solid #e1dad2;background:#fdf8f3;padding:10px 12px;font-size:.9rem}
.totals-box div{display:flex;justify-content:space-between;margin-bottom:4px}
.totals-box .final{margin-top:6px;padding-top:6px;border-top:1px dashed #d0c1b3;font-weight:600;color:#8c6f5b;font-size:1rem}
.meta{font-size:.85rem;color:#6f6660;display:flex;align-items:flex-end}
.contact{margin-top:22px;border-top:1px solid #e1dad2;padding-top:10px;font-size:.85rem;color:#6f6660}
.contact-title{font-weight:600;margin-bottom:4px}
.contact-line{margin-bottom:2px}
.note{margin-top:8px;font-size:.8rem;color:#8a7f77}
</style>
</head>

<body>
<div class="card">
  <div class="header">
    <div>
      <h2>فاکتور فروش</h2>
      <span>Belvia Online Shop</span>
    </div>
    <img src="${location.origin}/Brown.png" alt="Belvia Logo">
  </div>

  <div class="body">
    <div class="info-row">
      <div>مشتری: <strong>${customer}</strong></div>
      <div>تاریخ: <strong>${date}</strong></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ردیف</th>
          <th>قیمت واحد (€)</th>
          <th>تخفیف</th>
          <th>قیمت نهایی (€)</th>
          <th>وزن (kg)</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml}
      </tbody>
    </table>

    <div class="totals-wrap">
      <div class="totals-box">
        <div><span>جمع کالا (پس از تخفیف):</span><span>${totalRetail.toFixed(2)} €</span></div>
        <div><span>هزینه ارسال:</span><span>${ship.toFixed(2)} €</span></div>
        <div class="final"><span>مبلغ نهایی قابل پرداخت (یورو):</span><span>${finalPriceCustomer.toFixed(2)} €</span></div>
        <div><span>مبلغ نهایی (تقریبی به ریال):</span><span>${finalPriceCustomerRialText}</span></div>
      </div>
      <div class="meta">
        <div>وزن کل سفارش: <strong>${weight.toFixed(2)} kg</strong></div>
      </div>
    </div>

    <div class="contact">
      <div class="contact-title">راه‌های ارتباط با ما:</div>
      <div class="contact-line">Instagram: <strong>@bybelvia_onlineshop</strong></div>
      <div class="contact-line">Telegram channel: <strong>@bybelviaonlineshop</strong></div>
      <div class="contact-line">Support (Telegram): <strong>@bybelvia</strong></div>
      <div class="note">هزینه‌ی ارسال از ایران تا درب منزل (پست داخلی / پیک) بر عهده‌ی مشتری است.</div>
    </div>
  </div>
</div>
</body>
</html>`;

  const win = window.open("", "_blank");
  if (!win) return;
  win.document.write(html);
  win.document.close();
  win.onload = () => win.print();
}
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js");
  });
}
</script>

</body>
</html>